{# Preserve compatibility with 1.2 - don't load this. #}
{#{% load url from future %}#}
<!DOCTYPE html>
<html>
  <head>
    <title>Scrapr</title>
    <meta charset='utf-8' />

    <!-- Load this first, as we want to override some styling. -->
    <link rel='stylesheet' type='text/css' href='https://ajax.googleapis.com/ajax/libs/jqueryui/1.8.9/themes/flick/jquery-ui.css' />
    <style>
      body {
        font-family: Arial;
        background-color: #fff7f7;
        font-size: 14px;
      }
      /* HTML5 fallback. */
      article, aside, details, figcaption, figure, footer, header, hgroup, menu, nav, section {
        display: block;
      }
      #tabs {
        -moz-box-shadow: 0px 0px 5px #888;
        -webkit-box-shadow: 0px 0px 5px #888;
        box-shadow: 0px 0px 5px #888;
        background-color: #fff;
        opacity: 0.9;
      }
      form {
        margin: 1%;
      }
      #results {
        float: left;
        width: 55%;
      }
      #tag-wrap {
        padding: 1%;
        float: right;
        width: 40%;
        -moz-box-shadow: 0px 0px 5px #888;
        -webkit-box-shadow: 0px 0px 5px #888;
        box-shadow: 0px 0px 5px #888;
        display: none;
      }
      .tweet {
        -moz-box-shadow: 0px 0px 1px #888;
        -webkit-box-shadow: 0px 0px 1px #888;
        box-shadow: 0px 0px 1px #888;
        padding: 1%;
        clear: both;
        display: none;
      }
      .profile-image {
        float: left;
        width: 7%;
      }
      .tweet-text {
        float: right;
        width: 88%;
        font-size: 0.85em;
      }
      .tweet-text a {
        color: #0073ea;
      }
      .tweet-text a:hover {
        color: red;
      }
      .tag {
        
      }
      .user, .date {
        font-size: 0.8em;
        font-style: italic;
        color: #789;
      }
      .clear {
        clear: both;
      }
    </style>
    <script type='text/javascript' src='https://ajax.googleapis.com/ajax/libs/jquery/1.4.4/jquery.min.js'>
    </script>
    <script type='text/javascript' src='https://ajax.googleapis.com/ajax/libs/jqueryui/1.8.9/jquery-ui.min.js'>
    </script>
    <script type="text/javascript" src="https://www.google.com/jsapi">
    </script>
    <!-- IE < 9 HTML5 fallback. -->
    <!--[if lt IE 9]> <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script> <![endif]-->
    <script type='text/javascript'>
      function post_search() {
        // Post with jQuery. The first two paramaters are the url and the serialized form, 
        // the third is the callback function, which we anonymously define inline.
        window.location.hash = $('input[type="search"]').val();
        $.post($(this).attr('action'), $(this).serialize(), function(data) {

          $('#results').empty();
          if (data.results.length == 0 || data.tags.length == 0) {
            $('#results').append('<div style="padding-left: 5%;"><h3>No results!</h3></div>');
            return;
          }
          
          // Fill results and show the tweets.
          $(data.results).each( function(i, v) {
            $('#results').append('<div class="tweet"></div>');
            $('#results .tweet:last').append('<div class="profile-image"><img src="' + v.user.profile_image_url + '" /></div>');
            $('#results .tweet:last').append('<div class="tweet-text">' + v.formatted_tweet + '<br /></div>');
            $('#results .tweet div:last').append('<span class="user">' + v.formatted_screen_name + '</span> ')
            $('#results .tweet div:last').append('<span class="date">' + v.relative_created_at + '</span>')
            $('#results .tweet:last').append('<br class="clear" />');
          });
          $('#results div').show('normal');
		      $('.tag').click(function() {
		        $('#dialog').attr('tag', $(this).text());
		        $('#dialog').attr('href', $(this).attr('href'));
		        $('#dialog').dialog('open');
		        return false;
		      })

          // Create the new chart.
          $('#tags').empty().parent().show();

          // The rest is just chart boilerplate.
          var tag_data = new google.visualization.DataTable();
          tag_data.addColumn('string', 'Tag');
          tag_data.addColumn('number', 'Count')
          tag_data.addRows(data.tags.length);

          $(data.tags).each( function(i, v) {
            tag_data.setValue(i, 0, v[0]);
            tag_data.setValue(i, 1, v[1]);
          });
          // Add the chart to the DOM and draw it.
          var chart = new google.visualization.ColumnChart(document.getElementById('tags'));
          chart.draw(tag_data, {
            height: 400, title: 'Co-occurring tags'
          });

          // Set bars clickable - clicking on one searches for that tag.
          google.visualization.events.addListener(chart, 'select', function() {
            var selection = chart.getSelection();
            $('input[type="search"]').val(tag_data.getValue(selection[0].row, 0));
            $('form').submit();
          });
        });
        // Return false to prevent the default action - form submission.
        return false;
      }

      $(document).ready( function() {
        // Intercept form submission, handle it with the post_search function defined above.
        $('form').submit(post_search);
        $('#dialog').dialog({autoOpen: false, buttons: [
          {text: 'View on Twitter', click: function() {
            window.location.href = $(this).attr('href');
          }},
	        {text: 'View Here', click: function() {
            $('input[type="search"]').val($(this).attr('tag'));
            $('form').submit();
            $(this).dialog('close');
          }}
	      ]});
        $('#tabs').tabs({
          
          // We're not loading any content dynamically - we just want tabs for interface navigation.
          // We return false in the click handler to prevent any other action.
          load: function(event, ui) {
            $('a', ui.panel).click( function() {
              return false;
            });
          }
        });
        
        if (window.location.hash != '') {
          $('input[type="search"]').val(window.location.hash);
          $('form').submit();
        }

      });
      // Load the Visualization API.
      google.load('visualization', '1', {'packages': ['corechart']});
    </script>
  </head>
  <body>
      <div id='tabs'>
        <ul>
          <li>
            <a href='#search'>Scrapr</a>
          </li>
          <li>
            <a href='#help'>Help</a>
          </li>
        </ul>
        <div id='search'>
          <form method='POST' action='/app/search/'>
            <input type='search' name='q' placeholder='Enter term' autofocus />
            <input type='submit' value='Search' />
          </form>
          <div id='main-wrap'>

            <div id='tag-wrap'>
              <div id='tags'>

              </div>
            </div>
            <div id='dialog' title='View Tag'>
              Would you like to go to Twitter to view results for this tag, or change the current
              term here?
            </div>
            <div id='results'>
            </div>
            <br class='clear' />
          </div>
        </div>
        <div id='help'>
          Do som estuff.
        </div>
      </div>
  </body>
</html>
